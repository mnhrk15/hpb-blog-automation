## **HotPepper Beauty ブログ自動生成・投稿アプリ 要件定義書**

### **1. システム概要**

### **1.1. 目的**

HotPepper Beauty (HPB) に掲載するブログ記事を、アップロードされた画像から自動で生成し、サロンボード（HPB用コンテンツ管理システム）への投稿作業を効率化・自動化するWebアプリケーションを開発する。

### **1.2. 開発フレームワーク・言語**

Python Flaskフレームワークを使用してWebアプリケーションとして開発する。ブラウザ自動操作にはPlaywrightライブラリを**ヘッドレスモード**で使用する。

### **1.3. 利用形態**

開発したアプリケーションはサーバーにデプロイし、利用者はWebブラウザ経由でアクセスして利用する。デプロイ方式（PaaS, IaaS, Docker等）は別途決定する。

### **1.4. 機能概要**

本アプリは以下の主要機能を提供する。

- ユーザーログイン機能（共通パスワード認証）
- ブログ用画像のアップロード機能（最大4枚）
- Gemini APIを利用したブログ記事（タイトル・本文）の自動生成機能
- 生成されたブログ記事の編集機能
- HPB店舗ページから取得したスタイリスト・クーポンの選択機能 (Playwrightによるスクレイピング)
- ブログ末尾に追加するテンプレート（署名、定型文、連絡先など）の入力機能
- 生成・編集したブログ記事のサロンボードへの自動投稿機能 (Playwrightによるヘッドレス自動操作、ロボット認証検出時は処理中断)

### **2. 機能要件**

### **2.1. ログイン機能**

- **認証方式:** 全ユーザー共通のパスワードによる認証を行う。利用者が限定されているため、個別アカウントは作成しない。
- **パスワード管理:** 共通パスワードは環境変数 `APP_PASSWORD`（仮称）等で管理する。
- **UI:** アプリケーションアクセス時にパスワード入力フィールドを表示し、認証成功後にメイン画面へ遷移する。

### **2.2. 画像アップロード機能**

- **ファイル形式:** 特定の形式に限定せず、一般的な画像ファイル（JPEG, PNG, GIF等）を受け付ける。
- **枚数:** 複数枚（最大4枚まで）の画像をアップロード可能とする。サロンボードの制限に合わせる。
- **サイズ/リサイズ:** 画像サイズや解像度の上限・下限は設けない。リサイズ処理は行わない。
- **UI:** ファイル選択ダイアログまたはドラッグ＆ドロップによる画像アップロードインターフェースを提供する。アップロードされた画像はプレビュー表示する。

### **2.3. ブログ生成機能**

- **AIモデル:** Google Gemini API の `gemini-2.0-flash` モデルを使用する。
- **APIキー管理:** Gemini APIキーは環境変数 `GEMINI_API_KEY`（仮称）等で管理する。
- **入力:** アップロードされた画像（最大4枚）を入力とする。
- **処理:**
    - 画像からヘアスタイルに関する情報を抽出するようGemini APIに指示する。
    - 抽出した情報に基づき、ブログのタイトルと本文を生成する。
    - ブログ本文は1000文字以内とするようGemini APIに指示する。
    - 複数枚の画像がある場合、生成された本文の適切な箇所（例: 各画像の説明の後など）に画像を挿入するよう指示する。（具体的な挿入箇所はGeminiの判断に委ねるか、別途ルールを設ける）
    - 生成されるブログの文体やトーンは特に指定しない。
- **出力:** 生成された「ブログタイトル」（最大全角25文字）と「ブログ本文」を表示する。
- **UI:**
    - 「ブログ生成」ボタンを設置する。処理中はローディング表示を行う。
    - 生成結果（タイトル、本文）は編集可能なテキストフィールドおよびテキストエリアに表示する。

### **2.4. スタイリスト・クーポン選択機能**

- **情報取得:**
    - **タイミング:** ブログ作成画面が表示される際、またはユーザーが更新ボタンを押した際に、HPBの店舗ページから情報をスクレイピングして取得する。
    - **対象URL:**
        - ユーザーがサロンのHPBトップページのURL（例: `https://beauty.hotpepper.jp/slnH000xxxxxx/`）を入力するフィールドを設ける。
        - アプリはこのURLを基に、以下のページにPlaywright（ヘッドレスモード）でアクセスして情報を取得する。
            - スタイリスト情報: `[入力されたURL]/stylist/`
            - クーポン情報: `[入力されたURL]/coupon/` (複数ページ対応あり)
    - **取得処理 (Playwright - ヘッドレス):**
        1. **スタイリスト情報:**
            - スタイリストページ (`/stylist/`) にアクセス。
            - セレクタ例 (`#mainContents > div.mT20 > div.oh.w745.mT20.pH10 > table > tbody > tr > td:nth-child(2) > div:nth-child(1) > p.mT10.fs16.b > a`) に合致する全要素から「スタイリスト名」(テキスト)と「スタイリストID」(`href`属性から抽出)を取得。
        2. **クーポン情報:**
            - クーポンページ (`/coupon/`) の1ページ目にアクセス。
            - ページ数判定要素 (`#mainContents > div:nth-child(2) > div.preListHead.mT20 > div > p.pa.bottom0.right0`) から最大ページ数を特定。
            - 1ページ目から最大ページまでループ (`/coupon/`, `/coupon/PN2.html`, ...)。
            - 各ページでクーポン名セレクタ例 (`#mainContents > div:nth-child(2) > div:nth-child(6) > table > tbody > tr > td.bgWhite.pr > div > div:nth-child(1) > div.mT5.b > p`) に合致する全要素から「クーポン名」(テキスト)を取得。
    - **除外情報:** なし。
    - **注意:** HPBのサイト構成変更により、セレクタが機能しなくなる可能性があることを明記。
- **UI:**
    - HPB店舗URL入力フィールドと情報取得/更新ボタンを設置。
    - スタイリスト: ドロップダウンリスト（表示: スタイリスト名, value: スタイリストID）。
    - クーポン: ドロップダウンリストまたは複数選択可能なリスト（表示: クーポン名）。

### **2.5. テンプレート機能**

- **入力:** ブログ記事の末尾に挿入するテンプレート情報（署名、定型文、連絡先など）をユーザーが自由に入力できるテキストエリアを設ける。
- **タイミング:** ブログ生成後、投稿前にユーザーが入力する。
- **処理:** 投稿時に、ここで入力された内容をブログ本文の末尾に追記する。

### **2.6. サロンボード自動投稿機能**

- **トリガー:** ユーザーがサロンボードのID、パスワードを入力し、「サロンボードに投稿」ボタンを押すことで処理を開始する。処理中はローディング表示を行う。
- **自動操作 (Playwright - ヘッドレスモード):**
    1. **サロンボードログイン:**
        - ユーザー入力ID/パスワードを `input[name="userId"]` と `input#jsiPwInput` に入力。
        - ログインボタン (`a.common-CNCcommon__primaryBtn.loginBtnSize`) をクリック。
    2. **ページ遷移:**
        - 「掲載管理」ボタン (`#globalNavi > ul.common-CLPcommon__globalNavi > li:nth-child(2) > a`) をクリック。
        - 「ブログ」ボタン (`#cmsForm > div > div > ul > li:nth-child(9) > a`) をクリック。
        - 「新規投稿」ボタン (`#newPosts`) をクリック。
    3. **ブログ内容入力:** ブログ編集入力画面で以下を実行。
        - **投稿者:** ユーザーがUIで選択したスタイリストIDに対応する`<option>`を `select#stylistId` で選択。
        - **カテゴリ:** 「おすすめスタイル」(`value="BL02"`) を `select#blogCategoryCd` で選択。
        - **タイトル:** UIのタイトル入力内容を `input#blogTitle` に入力。
        - **本文:** UIの本文内容＋テンプレート内容を結合し、nicEditエディタ (`textarea#blogContents` に関連付けられたエディタ) に適切に入力する（Playwrightの `fill` や `evaluate` 等を駆使してnicEditのAPIを操作する必要がある可能性）。
        - **画像:**
            - 「画像アップロード」ボタン (`a#upload`) をクリックし、画像アップロードモーダル (`div.jscImageUploaderModal`) を表示。
            - ユーザーがアプリにアップロードした画像ファイル（最大4枚）を、モーダル内のファイル入力 (`input#sendFile`) を利用して1枚ずつ選択・登録。
            - nicEditの機能を利用して、本文の適切な箇所（Geminiが指示した箇所 or 事前定義ルール）に画像を挿入する。
        - **クーポン:**
            - 「クーポン選択」ボタン (`a.jsc_SB_modal_trigger`) をクリックし、クーポン選択モーダル (`div#couponWrap`) を表示。
            - ユーザーがUIで選択したクーポンをモーダル内で選択し、「設定する」ボタン (`a.jsc_SB_modal_setting_btn`) をクリック。
    4. **確認・投稿:**
        - 「確認する」ボタン (`a#confirm`) をクリック。
        - （もし確認画面があれば）内容を確認し、「登録する」（または相当する）ボタンをクリック。※確認画面の有無とボタンセレクタは実装時に要確認。
- **ロボット認証対応 (修正):**
    - 自動操作の**いずれかのステップ**で、ロボット認証（CAPTCHA）に関連する要素が**検出された場合、それ以上の自動操作を行わず、投稿処理全体を中断する。**
    - ユーザーに認証解除を促す**操作は行わない。**
- **エラーハンドリング (修正):**
    - ログイン失敗、ページ要素が見つからない、ネットワークエラー、投稿内容バリデーションエラー、**またはロボット認証の検出**により処理を継続できない場合、自動投稿処理を中断する。
    - エラー内容を示すメッセージ（例: 「ログインに失敗しました。」、「投稿ページの要素が見つかりません。」、「ロボット認証が検出されたため処理を中断しました。」など）を画面に表示する。リトライ処理は行わない。
- **完了通知:**
    - 投稿処理が（ロボット認証やその他のエラーで中断されずに）正常に完了した場合、「サロンボードへのブログ投稿が完了しました。」というメッセージを画面に表示する。

### **3. 非機能要件**

### **3.1. セキュリティ**

- **認証情報:** ユーザーが入力するサロンボードID/パスワードはアプリ内に保存せず、投稿処理の都度利用し、処理完了後は破棄する。
- **機密情報:** アプリケーション共通パスワード、Gemini APIキーは環境変数で管理する。
- **HTTPS:** デプロイ時にはHTTPS通信を必須とする（SSL/TLS証明書の設定）。

### **3.2. パフォーマンス/可用性**

- Gemini API呼び出し、スクレイピング、ブラウザ自動操作には時間がかかる可能性があるため、処理中であることがユーザーに分かるUI（ローディング表示等）を実装する。
- サロンボードやHPBの仕様変更、ネットワーク障害、**ロボット認証の導入・強化**により、機能が正常に動作しなくなる可能性がある。

### **3.3. UI/UX**

- シンプルで直感的に操作できるインターフェースを目指す。
- 各ステップでユーザーが迷わないよう、適切なラベル、説明、ガイドを表示する。

### **3.4. 動作環境**

- **サーバー:** Python実行環境、Playwrightおよびその依存ブラウザが動作する環境。ヘッドレス実行のため、GUI環境や仮想ディスプレイは不要。
- **クライアント:** 主要なモダンWebブラウザ（Google Chrome, Firefox, Edgeの最新版）。

### **3.5. 保守性**

- HPB/サロンボードのセレクタ情報は、コード内の分かりやすい箇所にまとめるか、設定ファイルとして分離するなど、変更を容易にする工夫を行う。
- Playwrightの操作は、適切な待機処理（PlaywrightのAuto-wait含む）を入れ、サイト側の変更にある程度耐えられるように実装する。
- コードには適切なコメントを付与する。

### **4. その他**

### **4.1. 提供範囲外**

- 個別ユーザーアカウント管理機能。
- テンプレートの保存・管理機能。
- サロンボードやHPBの仕様変更に伴う、スクレイピング・自動投稿処理の恒久的なメンテナンス保証（別途保守契約が必要）。
- 生成されたブログ内容の品質・正確性の保証（最終的な確認・編集はユーザーが行う）。
- 詳細な操作ログ・エラーログの永続的な保存機能。
- **ロボット認証の突破・回避機能。**